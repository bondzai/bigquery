version: '3.8'

services:
  # ============================================
  # BigQuery CRUD API
  # ============================================
  api:
    build:
      context: .
      dockerfile: Dockerfile
      target: production
    container_name: bigquery-crud-api
    ports:
      - "8080:8080"
    environment:
      # Server settings
      - NODE_ENV=development
      - PORT=8080
      # BigQuery settings
      - GOOGLE_PROJECT_ID=${GOOGLE_PROJECT_ID:-your-project-id}
      - BIGQUERY_DATASET=${BIGQUERY_DATASET:-test_dataset}
      - BIGQUERY_TABLE=${BIGQUERY_TABLE:-items}
      - BIGQUERY_LOCATION=${BIGQUERY_LOCATION:-US}
      # Feature flags
      - ENABLE_MOCK_MODE=${ENABLE_MOCK_MODE:-false}
      # Google Cloud credentials (mount from host)
      - GOOGLE_APPLICATION_CREDENTIALS=/app/credentials/service-account.json
    volumes:
      # Mount credentials from host
      # Create a credentials folder with your service account JSON file
      - ./credentials:/app/credentials:ro
    restart: unless-stopped
    healthcheck:
      test: [ "CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    networks:
      - bigquery-network

  # ============================================
  # Development with hot-reload
  # ============================================
  api-dev:
    build:
      context: .
      dockerfile: Dockerfile
      target: builder
    container_name: bigquery-crud-api-dev
    ports:
      - "8080:8080"
    environment:
      - NODE_ENV=development
      - PORT=8080
      - GOOGLE_PROJECT_ID=${GOOGLE_PROJECT_ID:-your-project-id}
      - BIGQUERY_DATASET=${BIGQUERY_DATASET:-test_dataset}
      - BIGQUERY_TABLE=${BIGQUERY_TABLE:-items}
      - BIGQUERY_LOCATION=${BIGQUERY_LOCATION:-US}
      - ENABLE_MOCK_MODE=${ENABLE_MOCK_MODE:-true}
      - GOOGLE_APPLICATION_CREDENTIALS=/app/credentials/service-account.json
    volumes:
      # Mount source code for hot-reload
      - ./src:/app/src:ro
      - ./credentials:/app/credentials:ro
    command: npm run dev
    networks:
      - bigquery-network
    profiles:
      - dev

networks:
  bigquery-network:
    driver: bridge
